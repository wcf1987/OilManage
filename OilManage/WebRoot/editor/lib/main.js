"use strict";var DIAGRAMO={debug:false,debugSolutions:[],visualMagnet:true};DIAGRAMO.switchDebug=function(c){if(c==undefined){DIAGRAMO.debug=!DIAGRAMO.debug}else{DIAGRAMO.debug=c}var d=document.getElementById("iconDebug");if(DIAGRAMO.debug){d.src="./assets/images/icon_debug_true.gif"}else{d.src="./assets/images/icon_debug_false.gif"}draw()};if(false){window.onerror=function(h,i,g,e){alert("Description: "+h+" Page: "+i+" Line: "+g+" Position: "+e)}}DIAGRAMO.fileVersion=3;var doUndo=true;var currentMoveUndo=null;var CONNECTOR_MANAGER=new ConnectorManager();var CONTAINER_MANAGER=new ContainerFigureManager();var currentCloud=[];var GRIDWIDTH=30;var SNAP_DISTANCE=5;var fillColor=null;var strokeColor="#000000";var currentText=null;var Browser=new Browser();var defaultEditorPadding=6;var defaultEditorBorderWidth=1;var FIGURE_ESCAPE_DISTANCE=30;var FIGURE_CLOUD_DISTANCE=4;var createFigureFunction=null;var CNTRL_PRESSED=false;var SHIFT_PRESSED=false;var connector=null;var connectorType="";var figureSets=[];var INDENTATION=0;function toSVG(){return""}function stopselection(b){if(b.target.className=="text"){return true}return false}var STACK=new Stack();var mousePressed=false;var STATE_NONE="none";var STATE_FIGURE_CREATE="figure_create";var STATE_FIGURE_SELECTED="figure_selected";var STATE_CONNECTOR_PICK_FIRST="connector_pick_first";var STATE_CONNECTOR_PICK_SECOND="connector_pick_second";var STATE_CONNECTOR_SELECTED="connector_selected";var STATE_CONNECTOR_MOVE_POINT="connector_move_point";var STATE_SELECTING_MULTIPLE="selecting_multiple";var STATE_GROUP_SELECTED="group_selected";var STATE_CONTAINER_SELECTED="container_selected";var STATE_TEXT_EDITING="text_editing";var state=STATE_NONE;var selectionArea=new Polygon();selectionArea.points.push(new Point(0,0));selectionArea.points.push(new Point(0,0));selectionArea.points.push(new Point(0,0));selectionArea.points.push(new Point(0,0));selectionArea.style.strokeStyle="grey";selectionArea.style.lineWidth="1";var gridVisible=false;var snapTo=false;var lastClick=[];var defaultLineWidth=2;var currentTextEditor=null;var selectedFigureId=-1;var selectedFigureThumb=null;var selectedGroupId=-1;var selectedConnectorId=-1;var selectedContainerId=-1;var selectedConnectionPointId=-1;var dragging=false;var insertedImageFileName=null;var canvasProps=null;var clipboardBuffer=[];function getCanvas(){var b=document.getElementById("a");return b}function getContext(){var b=getCanvas();if(b.getContext){return b.getContext("2d")}else{alert("You need a HTML5 web browser. Any Safari,Firefox, Chrome or Explorer supports this.")}}var currentSetId="basic";function setFigureSet(g){Log.info("main.js id = "+g);var d=document.getElementById(g);if(d!=null){if(currentSetId!=null){Log.info("main.js currentSetId = "+currentSetId);var e=document.getElementById(currentSetId);e.style.display="none"}d.style.display="block";currentSetId=g}}function updateShape(r,i,z,B,y){B=B||false;var w=STACK.figureGetById(r);if(!w){w=CONNECTOR_MANAGER.connectorGetById(r)}if(!w){w=STACK.containerGetById(r)}var A=w;var s=i.split(".");var t=w;for(var x=0;x<s.length-1;x++){w=w[s[x]]}var v=s[s.length-1];var u="set"+Util.capitaliseFirstLetter(v);var C="get"+Util.capitaliseFirstLetter(v);if(u in w){if((typeof(y)!=="undefined"&&y!=w[C])||(typeof(y)==="undefined"&&z!=w[C]())){var q=new ShapeChangePropertyCommand(r,i,z,y);q.execute();if(!B){History.addUndo(q)}}w[u](z)}else{if((typeof(y)!=="undefined"&&w[v]!=y)||(typeof(y)==="undefined"&&w[v]!=z)){var q=new ShapeChangePropertyCommand(r,i,z,y);q.execute();if(!B){History.addUndo(q)}w[v]=z}}if(A instanceof Connector&&v=="str"){A.updateMiddleText()}draw()}function setUpEditPanel(d){var c=document.getElementById("edit");c.innerHTML="";if(d==null){}else{switch(d.oType){case"Group":break;case"Container":Builder.constructPropertiesPanel(c,d);break;case"CanvasProps":Builder.constructCanvasPropertiesPanel(c,d);break;default:Builder.constructPropertiesPanel(c,d)}}}function setUpTextEditorPopup(i,e){var h=document.getElementById("text-editor");var g=document.getElementById("text-editor-tools");currentTextEditor=Builder.constructTextPropertiesPanel(h,g,i,e)}function createFigure(c,d){createFigureFunction=c;selectedFigureThumb=d;selectedFigureId=-1;selectedConnectorId=-1;selectedConnectionPointId=-1;if(state==STATE_TEXT_EDITING){currentTextEditor.destroy();currentTextEditor=null}state=STATE_FIGURE_CREATE;draw()}function resetToNoneState(){if(state==STATE_TEXT_EDITING){currentTextEditor.destroy();currentTextEditor=null}selectedFigureId=-1;selectedConnectionPointId=-1;selectedConnectorId=-1;selectedContainerId=-1;if(state==STATE_GROUP_SELECTED){var b=STACK.groupGetById(selectedGroupId);if(!b.permanent){STACK.groupDestroy(selectedGroupId)}selectedGroupId=-1}state=STATE_NONE}var uploadImageErrorDivId="upload-image-error";function showInsertImageDialog(){resetToNoneState();draw();setUploadedImagesList();var c=document.getElementById("insert-image-dialog");$.modal(c,{minWidth:"380px",containerId:"upload-image-dialog",overlayClose:true});$.modal.setPosition();var d=document.getElementById(uploadImageErrorDivId);d.innerHTML=""}function setUploadedImagesList(){$.post("./common/controller.php",{action:"getUploadedImageFileNames"},function(j){var k=document.getElementById("insert-image-reuse");var i=document.getElementById("insert-image-reuse-group");j=JSON.parse(j);if(j!=null&&j.length){var h,l=j.length,m;for(h=0;h<l;h++){m=document.createElement("option");m.value=j[h];m.textContent=j[h];k.appendChild(m)}k.disabled=false;i.disabled=false}else{k.disabled=true;i.disabled=true}})}function insertImage(g,e){if(e){var d=document.getElementById(uploadImageErrorDivId);d.innerHTML=e;$.modal.setPosition()}else{$.modal.close();insertedImageFileName=g;action("insertImage")}}function snapToGrid(){Log.info("snapToGrid called;");snapTo=!snapTo;if(snapTo){if(!gridVisible){gridVisible=true;backgroundImage=null;document.getElementById("gridCheckbox").checked=true;draw()}}}function showGrid(){if(gridVisible){if(snapTo){snapTo=false;document.getElementById("snapCheckbox").checked=false}}gridVisible=!gridVisible;backgroundImage=null;draw()}function onClick(e){var i=getCanvasXY(e);var g=i[0];var h=i[1]}function onDoubleClick(k){var j=getCanvasXY(k);var g=getCanvas();var h=j[0];var i=j[1];lastClick=[h,i];alert("Double click triggered")}function onKeyPress(b){if(b.target.className=="text"){return true}draw();return false}function onKeyDown(m){if(m.target.className=="text"){return true}m.KEY=m.keyCode;switch(m.KEY){case KEY.ESCAPE:createFigureFunction=null;if(selectedFigureId!=-1||selectedConnectionPointId!=-1||selectedConnectorId!=-1){redraw=true}selectedFigureId=-1;selectedConnectionPointId=-1;selectedConnectorId=-1;if(state==STATE_TEXT_EDITING){currentTextEditor.destroy();currentTextEditor=null}state=STATE_NONE;break;case KEY.DELETE:switch(state){case STATE_FIGURE_SELECTED:if(selectedFigureId!=-1){var o=new FigureDeleteCommand(selectedFigureId);o.execute();History.addUndo(o)}break;case STATE_GROUP_SELECTED:if(selectedGroupId!=-1){var s=new GroupDeleteCommand(selectedGroupId);s.execute();History.addUndo(s)}break;case STATE_CONNECTOR_SELECTED:Log.group("Delete connector");if(selectedConnectorId!=-1){var q=new ConnectorDeleteCommand(selectedConnectorId);q.execute();History.addUndo(q)}Log.groupEnd();break;case STATE_CONTAINER_SELECTED:Log.group("Delete container");if(selectedContainerId!=-1){var n=new ContainerDeleteCommand(selectedContainerId);n.execute();History.addUndo(n)}Log.groupEnd();break}break;case KEY.SHIFT:SHIFT_PRESSED=true;break;case KEY.CTRL:case KEY.COMMAND_LEFT:case KEY.COMMAND_FIREFOX:CNTRL_PRESSED=true;break;case KEY.LEFT:action("left");return false;break;case KEY.UP:action("up");return false;break;case KEY.RIGHT:action("right");return false;break;case KEY.DOWN:action("down");return false;break;case KEY.Z:if(CNTRL_PRESSED){action("undo")}break;case KEY.G:if(CNTRL_PRESSED){action("group")}break;case KEY.U:if(CNTRL_PRESSED){action("ungroup")}break;case KEY.D:if(CNTRL_PRESSED){if(m.preventDefault){m.preventDefault()}else{m.returnValue=false}action("duplicate")}break;case KEY.C:if(CNTRL_PRESSED){if(selectedFigureId!=-1){clipboardBuffer[0]="figure";clipboardBuffer[1]=selectedFigureId}else{if(selectedGroupId!=-1){clipboardBuffer[0]="group";clipboardBuffer[1]=selectedGroupId}else{clipboardBuffer[0]="";clipboardBuffer[1]=-1}}}break;case KEY.V:if(CNTRL_PRESSED){if(clipboardBuffer[0]){switch(state){case STATE_NONE:if(clipboardBuffer[0]=="figure"){selectedFigureId=clipboardBuffer[1];action("duplicate")}else{if(clipboardBuffer[0]=="group"){selectedGroupId=clipboardBuffer[1];if(STACK.groupGetById(selectedGroupId)){action("duplicate")}}}break;case STATE_FIGURE_SELECTED:if(clipboardBuffer[0]=="figure"){if(clipboardBuffer[1]==selectedFigureId){action("duplicate");clipboardBuffer[1]=selectedFigureId}else{var i=STACK.figureGetById(clipboardBuffer[1]);var p=STACK.figureGetById(selectedFigureId);p.applyAnotherFigureStyle(i)}}break;case STATE_GROUP_SELECTED:if(clipboardBuffer[1]==selectedGroupId){action("duplicate");clipboardBuffer[1]=selectedGroupId}else{if(clipboardBuffer[0]=="figure"){var i=STACK.figureGetById(clipboardBuffer[1]);var l=STACK.figureGetByGroupId(selectedGroupId);for(var r=0;r<l.length;r++){l[r].applyAnotherFigureStyle(i)}}}break}}}break;case KEY.S:if(CNTRL_PRESSED){save();m.preventDefault()}break;case KEY.P:if(currentDiagramId!==null){if(CNTRL_PRESSED){Log.info("CTRL-P pressed  ");print_diagram();m.preventDefault()}}break}draw();return false}function onKeyUp(b){switch(b.keyCode){case KEY.SHIFT:SHIFT_PRESSED=false;break;case KEY.ALT:CNTRL_PRESSED=false;break;case KEY.CTRL:CNTRL_PRESSED=false;break}return false}function onMouseDown(y){var E=getCanvasXY(y);var U=getCanvas();var K=E[0];var M=E[1];lastClick=[K,M];mousePressed=true;switch(state){case STATE_TEXT_EDITING:if(currentTextEditor.mouseClickedInside(y)){break}else{if(Browser.msie||Browser.mozilla){currentTextEditor.blurTextArea()}currentTextEditor.destroy();currentTextEditor=null;state=STATE_NONE}case STATE_NONE:snapMonitor=[0,0];var I=CONNECTOR_MANAGER.connectorGetByXY(K,M);if(I!=-1){selectedConnectorId=I;state=STATE_CONNECTOR_SELECTED;var R=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId);setUpEditPanel(R);Log.info("onMouseDown() + STATE_NONE  - change to STATE_CONNECTOR_SELECTED");redraw=true}else{var T=STACK.figureGetByXY(K,M);if(T!=-1){if(STACK.figureGetById(T).groupId!=-1){selectedGroupId=STACK.figureGetById(T).groupId;var N=STACK.groupGetById(selectedGroupId);state=STATE_GROUP_SELECTED;Log.info("onMouseDown() + STATE_NONE + group selected  =>  change to STATE_GROUP_SELECTED")}else{selectedFigureId=T;var C=STACK.figureGetById(T);setUpEditPanel(C);state=STATE_FIGURE_SELECTED;Log.info("onMouseDown() + STATE_NONE + lonely figure => change to STATE_FIGURE_SELECTED")}redraw=true}else{var B=STACK.containerGetByXY(K,M);if(B!==-1){var H=STACK.containerGetById(B);setUpEditPanel(H);state=STATE_CONTAINER_SELECTED;selectedContainerId=B;Log.info("onMouseDown() + STATE_NONE  - change to STATE_CONTAINER_SELECTED")}else{}}}break;case STATE_FIGURE_CREATE:throw"canvas> onMouseDown> STATE_FIGURE_CREATE> : this should not happen";break;case STATE_FIGURE_SELECTED:snapMonitor=[0,0];if(HandleManager.handleGet(K,M)!=null){Log.info("onMouseDown() + STATE_FIGURE_SELECTED - handle selected");HandleManager.handleSelectXY(K,M)}else{var I=CONNECTOR_MANAGER.connectorGetByXY(K,M);if(I!=-1){state=STATE_CONNECTOR_SELECTED;selectedConnectorId=I;var R=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId);HandleManager.shapeSet(R);setUpEditPanel(R);Log.info("onMouseDown() + STATE_FIGURE_SELECTED  - change to STATE_CONNECTOR_SELECTED");redraw=true}else{var T=STACK.figureGetByXY(K,M);if(T==-1){if(!SHIFT_PRESSED){selectedFigureId=-1;var B=STACK.containerGetByXY(K,M);if(B!=-1){var H=STACK.containerGetById(B);setUpEditPanel(H);state=STATE_CONTAINER_SELECTED;selectedContainerId=B;Log.info("onMouseDown() + STATE_FIGURE_SELECTED  - change to STATE_CONTAINER_SELECTED")}else{state=STATE_NONE;setUpEditPanel(canvasProps);Log.info("onMouseDown() + STATE_FIGURE_SELECTED  - change to STATE_NONE")}redraw=true}}else{if(T==selectedFigureId){}else{if(SHIFT_PRESSED){var x=[];if(selectedFigureId!=-1){x.push(selectedFigureId)}var C=STACK.figureGetById(T);if(C.groupId!=-1){var J=STACK.figureGetByGroupId(C.groupId);for(var D=0;D<J.length;D++){x.push(J[D].id)}}else{x.push(T)}selectedGroupId=STACK.groupCreate(x);state=STATE_GROUP_SELECTED;setUpEditPanel(null);redraw=true;Log.info("onMouseDown() + STATE_FIGURE_SELECTED + SHIFT  + min. 2 figures => STATE_GROUP_SELECTED")}else{var C=STACK.figureGetById(T);if(C.groupId!=-1){selectedFigureId=-1;selectedGroupId=C.groupId;state=STATE_GROUP_SELECTED;setUpEditPanel(null);redraw=true;Log.info("onMouseDown() + STATE_FIGURE_SELECTED + group figure => change to STATE_GROUP_SELECTED")}else{selectedFigureId=T;HandleManager.clear();var C=STACK.figureGetById(T);setUpEditPanel(C);redraw=true;Log.info("onMouseDown() + STATE_FIGURE_SELECTED + single figure => change to STATE_FIGURE_SELECTED (different figure)")}}}}}}break;case STATE_GROUP_SELECTED:var O=STACK.groupGetById(selectedGroupId);if(HandleManager.handleGet(K,M)!=null){HandleManager.handleSelectXY(K,M);redraw=true;Log.info("onMouseDown() + STATE_GROUP_SELECTED  + handle selected => STATE_GROUP_SELECTED")}else{if(CONNECTOR_MANAGER.connectorGetByXY(K,M)!=-1){if(!O.permanent){STACK.groupDestroy(selectedGroupId)}selectedGroupId=-1;selectedConnectorId=CONNECTOR_MANAGER.connectorGetByXY(K,M);state=STATE_CONNECTOR_SELECTED;redraw=true;Log.info("onMouseDown() + STATE_GROUP_SELECTED  + handle selected => STATE_CONNECTOR_SELECTED")}else{if(STACK.figureGetByXY(K,M)!=-1){var T=STACK.figureGetByXY(K,M);var i=STACK.figureGetById(T);if(i.groupId==-1){if(SHIFT_PRESSED){var x=[];var J=STACK.figureGetByGroupId(selectedGroupId);for(var D=0;D<J.length;D++){x.push(J[D].id)}x.push(T);if(!O.permanent){STACK.groupDestroy(selectedGroupId)}selectedGroupId=STACK.groupCreate(x);Log.info("onMouseDown() + STATE_GROUP_SELECTED + SHIFT  + add lonely figure to other")}else{if(!O.permanent){STACK.groupDestroy(selectedGroupId)}selectedGroupId=-1;state=STATE_FIGURE_SELECTED;selectedFigureId=T;Log.info("onMouseDown() + STATE_GROUP_SELECTED  + lonely figure => STATE_FIGURE_SELECTED");setUpEditPanel(i);redraw=true}}else{if(i.groupId!=selectedGroupId){if(SHIFT_PRESSED){var x=[];var J=STACK.figureGetByGroupId(selectedGroupId);for(var D=0;D<J.length;D++){x.push(J[D].id)}J=STACK.figureGetByGroupId(i.groupId);for(var D=0;D<J.length;D++){x.push(J[D].id)}if(!O.permanent){STACK.groupDestroy(selectedGroupId)}selectedGroupId=STACK.groupCreate(x)}else{if(!O.permanent){STACK.groupDestroy(selectedGroupId)}selectedGroupId=i.groupId}redraw=true;Log.info("onMouseDown() + STATE_GROUP_SELECTED  + (different) group figure => STATE_GROUP_SELECTED")}else{}}}else{if(!SHIFT_PRESSED){if(!O.permanent){STACK.groupDestroy(selectedGroupId)}selectedGroupId=-1;state=STATE_NONE;redraw=true;Log.info("onMouseDown() + STATE_GROUP_SELECTED  + mouse on empty => STATE_NONE")}}}}break;case STATE_CONNECTOR_PICK_FIRST:connectorPickFirst(K,M,y);break;case STATE_CONNECTOR_PICK_SECOND:state=STATE_NONE;break;case STATE_CONNECTOR_SELECTED:var L=CONNECTOR_MANAGER.connectionPointGetAllByParent(selectedConnectorId);var P=L[0];var S=L[1];var F;if(P.point.near(K,M,3)){Log.info("Picked the start point");selectedConnectionPointId=P.id;state=STATE_CONNECTOR_MOVE_POINT;U.style.cursor="default";var Q=new ConnectorAlterCommand(selectedConnectorId);History.addUndo(Q);F=CONNECTOR_MANAGER.connectionPointGetByXYRadius(K,M,FIGURE_CLOUD_DISTANCE,ConnectionPoint.TYPE_FIGURE,S);if(F!==-1){currentCloud=[selectedConnectionPointId,F]}}else{if(S.point.near(K,M,3)){Log.info("Picked the end point");selectedConnectionPointId=S.id;state=STATE_CONNECTOR_MOVE_POINT;U.style.cursor="default";var Q=new ConnectorAlterCommand(selectedConnectorId);History.addUndo(Q);F=CONNECTOR_MANAGER.connectionPointGetByXYRadius(K,M,FIGURE_CLOUD_DISTANCE,ConnectionPoint.TYPE_FIGURE,P);if(F!==-1){currentCloud=[selectedConnectionPointId,F]}}else{if(HandleManager.handleGet(K,M)!=null){Log.info("onMouseDown() + STATE_CONNECTOR_SELECTED - handle selected");HandleManager.handleSelectXY(K,M);var Q=new ConnectorAlterCommand(selectedConnectorId);History.addUndo(Q)}else{var G=CONNECTOR_MANAGER.connectorGetByXY(K,M);switch(G){case -1:selectedConnectorId=-1;state=STATE_NONE;setUpEditPanel(canvasProps);redraw=true;break;case selectedConnectorId:break;default:selectedConnectorId=G;setUpEditPanel(CONNECTOR_MANAGER.connectorGetById(selectedConnectorId));state=STATE_CONNECTOR_SELECTED;redraw=true}}}}break;case STATE_CONTAINER_SELECTED:if(HandleManager.handleGet(K,M)!=null){Log.info("onMouseDown() + STATE_CONTAINER_SELECTED - handle selected");HandleManager.handleSelectXY(K,M)}else{var I=CONNECTOR_MANAGER.connectorGetByXY(K,M);if(I!==-1){selectedConnectorId=I;state=STATE_CONNECTOR_SELECTED;var R=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId);setUpEditPanel(R);Log.info("onMouseDown() + STATE_CONTAINER_SELECTED  - change to STATE_CONNECTOR_SELECTED");redraw=true}else{var T=STACK.figureGetByXY(K,M);if(T!=-1){if(STACK.figureGetById(T).groupId!=-1){selectedGroupId=STACK.figureGetById(T).groupId;var N=STACK.groupGetById(selectedGroupId);state=STATE_GROUP_SELECTED;Log.info("onMouseDown() + STATE_CONTAINER_SELECTED + group selected  =>  change to STATE_GROUP_SELECTED")}else{selectedFigureId=T;var C=STACK.figureGetById(T);setUpEditPanel(C);state=STATE_FIGURE_SELECTED;Log.info("onMouseDown() + STATE_CONTAINER_SELECTED + lonely figure => change to STATE_FIGURE_SELECTED")}redraw=true}else{var B=STACK.containerGetByXY(K,M);if(B==-1){state=STATE_NONE;setUpEditPanel(canvasProps);selectedContainerId=-1;HandleManager.clear();Log.info("onMouseDown() + STATE_CONTAINER_SELECTED + click on nothing - change to STATE_NONE")}else{if(B!=selectedContainerId){var H=STACK.containerGetById(B);setUpEditPanel(H);state=STATE_CONTAINER_SELECTED;selectedContainerId=B;Log.info("onMouseDown() + STATE_NONE  - change to STATE_CONTAINER_SELECTED")}else{}}}}}break;default:}draw();return false}function onMouseUp(x){Log.info("main.js>onMouseUp()");var v=getCanvasXY(x);var u=v[0];var y=v[1];lastClick=[];mousePressed=true;switch(state){case STATE_NONE:if(HandleManager.handleGetSelected()){HandleManager.clear()}break;case STATE_FIGURE_SELECTED:mousePressed=false;HandleManager.handleSelectedIndex=-1;break;case STATE_CONTAINER_SELECTED:mousePressed=false;HandleManager.handleSelectedIndex=-1;break;case STATE_GROUP_SELECTED:Log.info("onMouseUp() + STATE_GROUP_SELECTED ...");mousePressed=false;HandleManager.handleSelectedIndex=-1;break;case STATE_SELECTING_MULTIPLE:Log.info("onMouseUp() + STATE_SELECTING_MULTIPLE => STATE_NONE");Log.info("onMouseUp() selection area: "+selectionArea);state=STATE_NONE;var D=[];if(SHIFT_PRESSED){if(selectedFigureId!=-1){D.push(selectedFigureId)}if(selectedGroupId!=-1){var z=STACK.groupGetById(selectedGroupId);var t=STACK.figureGetByGroupId(selectedGroupId);for(var B=0;B<t.length;B++){D.push(t[B].id)}}}for(var B=0;B<STACK.figures.length;B++){if(STACK.figures[B].groupId==-1){var s=STACK.figures[B].getPoints();if(s.length==0){s.push(new Point(STACK.figures[B].getBounds()[0],STACK.figures[B].getBounds()[1]));s.push(new Point(STACK.figures[B].getBounds()[2],STACK.figures[B].getBounds()[3]));s.push(new Point(STACK.figures[B].getBounds()[0],STACK.figures[B].getBounds()[3]));s.push(new Point(STACK.figures[B].getBounds()[2],STACK.figures[B].getBounds()[1]))}var A=false;for(var w=0;w<s.length;w++){if(Util.isPointInside(s[w],selectionArea.getPoints())){D.push(STACK.figures[B].id);A=true;break}}if(!A){A=Util.polylineIntersectsRectangle(s,selectionArea.getBounds(),true)}if(A){D.push(STACK.figures[B].id)}}}if(selectedGroupId!=-1){var z=STACK.groupGetById(selectedGroupId);if(!z.permanent){STACK.groupDestroy(selectedGroupId)}}if(D.length>=2){selectedGroupId=STACK.groupCreate(D);state=STATE_GROUP_SELECTED;setUpEditPanel(null);Log.info("onMouseUp() + STATE_SELECTING_MULTIPLE  + min. 2 figures => STATE_GROUP_SELECTED")}else{if(D.length==1){selectedFigureId=D[0];selectedGroupId=-1;state=STATE_FIGURE_SELECTED;Log.info("onMouseUp() + STATE_SELECTING_MULTIPLE  + 1 figure => STATE_FIGURE_SELECTED")}}break;case STATE_CONNECTOR_PICK_SECOND:var a=new ConnectorCreateCommand(selectedConnectorId);History.addUndo(a);CONNECTOR_MANAGER.connectionPointsResetColor();currentCloud=[];state=STATE_CONNECTOR_SELECTED;var E=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId);setUpEditPanel(E);redraw=true;break;case STATE_CONNECTOR_MOVE_POINT:CONNECTOR_MANAGER.connectionPointsResetColor();currentCloud=[];state=STATE_CONNECTOR_SELECTED;selectedConnectionPointId=-1;redraw=true;break;case STATE_CONNECTOR_SELECTED:if(currentMoveUndo){var i=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId).turningPoints;var C=[i.length];for(var B=0;B<i.length;B++){C[B]=i[B].clone()}currentMoveUndo.currentValue=C;History.addUndo(currentMoveUndo);state=STATE_NONE;selectedConnectorId=-1;HandleManager.clear()}break}currentMoveUndo=null;mousePressed=false;draw()}var lastMove=null;var snapMonitor=[0,0];function onMouseMove(P){var aa=false;var Y=getCanvasXY(P);if(Y==null){Log.error("main.js onMouseMove() null coordinates");return}var ab=Y[0];var ae=Y[1];var ak=getCanvas();Log.debug("onMouseMoveCanvas: test if over a figure: "+ab+","+ae);switch(state){case STATE_NONE:if(mousePressed){state=STATE_SELECTING_MULTIPLE;selectionArea.points[0]=new Point(ab,ae);selectionArea.points[1]=new Point(ab,ae);selectionArea.points[2]=new Point(ab,ae);selectionArea.points[3]=new Point(ab,ae);Log.debug("onMouseMove() - STATE_NONE + mousePressed = STATE_SELECTING_MULTIPLE")}else{if(STACK.figureIsOver(ab,ae)){ak.style.cursor="move";Log.debug("onMouseMove() - STATE_NONE - mouse cursor = move (over figure)")}else{if(CONNECTOR_MANAGER.connectorGetByXY(ab,ae)!=-1){ak.style.cursor="move";Log.debug("onMouseMove() - STATE_NONE - mouse cursor = move (over connector)")}else{if(STACK.containerGetByXY(ab,ae)!=-1){ak.style.cursor="move";Log.debug("onMouseMove() - STATE_NONE - mouse cursor = move (over container)")}else{ak.style.cursor="default";Log.debug("onMouseMove() - STATE_NONE - mouse cursor = default")}}}}break;case STATE_SELECTING_MULTIPLE:selectionArea.points[1].x=ab;selectionArea.points[2].x=ab;selectionArea.points[2].y=ae;selectionArea.points[3].y=ae;aa=true;break;case STATE_FIGURE_CREATE:if(createFigureFunction){ak.style.cursor="crosshair"}break;case STATE_FIGURE_SELECTED:if(mousePressed){if(lastMove!=null){var y=HandleManager.handleGetSelected();if(y!=null){ak.style.cursor=y.getCursor();y.action(lastMove,ab,ae);aa=true;Log.info("onMouseMove() - STATE_FIGURE_SELECTED + drag - mouse cursor = "+ak.style.cursor)}else{if(!SHIFT_PRESSED){ak.style.cursor="move";var Z=generateMoveMatrix(STACK.figureGetById(selectedFigureId),ab,ae);Log.info("onMouseMove() + STATE_FIGURE_SELECTED : translation matrix"+Z);var V=new FigureTranslateCommand(selectedFigureId,Z);History.addUndo(V);V.execute();var c=STACK.figureGetById(selectedFigureId);var al=c.getBounds();var R=CONTAINER_MANAGER.getContainerForFigure(selectedFigureId);if(R!==-1){var W=STACK.containerGetById(R);var am=W.getBounds();if(Util.areBoundsInBounds(al,am)){}else{CONTAINER_MANAGER.removeFigure(R,selectedFigureId)}}else{var X=-1;for(var N=0;N<STACK.containers.length;N++){var ag=STACK.containers[N];if(Util.areBoundsInBounds(al,ag.getBounds())){X=STACK.containers[N].id;break}}if(X!==-1){CONTAINER_MANAGER.addFigure(X,selectedFigureId)}}aa=true;Log.info("onMouseMove() + STATE_FIGURE_SELECTED + drag - move selected figure")}else{state=STATE_SELECTING_MULTIPLE;selectionArea.points[0]=new Point(ab,ae);selectionArea.points[1]=new Point(ab,ae);selectionArea.points[2]=new Point(ab,ae);selectionArea.points[3]=new Point(ab,ae);aa=true;Log.info("onMouseMove() - STATE_GROUP_SELECTED + mousePressed + SHIFT => STATE_SELECTING_MULTIPLE")}}}}else{var y=HandleManager.handleGet(ab,ae);if(y!=null){ak.style.cursor=y.getCursor();Log.info("onMouseMove() - STATE_FIGURE_SELECTED + over a Handler = change cursor to: "+ak.style.cursor)}else{var O=STACK.figureGetByXY(ab,ae);if(O!=-1){ak.style.cursor="move";Log.info("onMouseMove() + STATE_FIGURE_SELECTED + over a figure = change cursor")}else{ak.style.cursor="default";Log.info("onMouseMove() + STATE_FIGURE_SELECTED + over nothin = change cursor to default")}}}break;case STATE_TEXT_EDITING:if(!mousePressed){var y=HandleManager.handleGet(ab,ae);if(y!=null){ak.style.cursor=y.getCursor();Log.info("onMouseMove() - STATE_TEXT_EDITING + over a Handler = change cursor to: "+ak.style.cursor)}else{var O=STACK.figureGetByXY(ab,ae);if(O!=-1){ak.style.cursor="move";Log.info("onMouseMove() + STATE_TEXT_EDITING + over a figure = change cursor")}else{ak.style.cursor="default";Log.info("onMouseMove() + STATE_TEXT_EDITING + over nothin = change cursor to default")}}}else{throw"main:onMouseMove() - this should never happen"}break;case STATE_CONTAINER_SELECTED:if(mousePressed){if(lastMove!=null){var y=HandleManager.handleGetSelected();if(y!=null){ak.style.cursor=y.getCursor();y.action(lastMove,ab,ae);aa=true;Log.info("onMouseMove() - STATE_CONTAINER_SELECTED + drag - mouse cursor = "+ak.style.cursor)}else{ak.style.cursor="move";var Z=generateMoveMatrix(STACK.containerGetById(selectedContainerId),ab,ae);Log.info("onMouseMove() + STATE_CONTAINER_SELECTED : translation matrix"+Z);var ao=new ContainerTranslateCommand(selectedContainerId,Z);History.addUndo(ao);ao.execute();aa=true;Log.info("onMouseMove() + STATE_CONTAINER_SELECTED + drag - move selected container")}}}else{var y=HandleManager.handleGet(ab,ae);if(y!=null){ak.style.cursor=y.getCursor();Log.info("onMouseMove() - STATE_CONTAINER_SELECTED + over a Handler = change cursor to: "+ak.style.cursor)}else{if(STACK.containerGetByXY(ab,ae)!==-1){ak.style.cursor="move";Log.info("onMouseMove() + STATE_CONTAINER_SELECTED + over a container's edge = change cursor")}else{ak.style.cursor="default";Log.debug("onMouseMove() + STATE_CONTAINER_SELECTED + over nothing = change cursor to default")}}}break;case STATE_GROUP_SELECTED:if(mousePressed){if(lastMove!=null){var y=HandleManager.handleGetSelected();if(y!=null){Log.info("onMouseMove() - STATE_GROUP_SELECTED + mouse pressed  + over a Handle");ak.style.cursor=y.getCursor();y.action(lastMove,ab,ae);aa=true}else{if(!SHIFT_PRESSED){Log.info("onMouseMove() - STATE_GROUP_SELECTED + mouse pressed + NOT over a Handle");ak.style.cursor="move";var ai=generateMoveMatrix(STACK.groupGetById(selectedGroupId),ab,ae);var U=new GroupTranslateCommand(selectedGroupId,ai);U.execute();History.addUndo(U);aa=true}else{state=STATE_SELECTING_MULTIPLE;selectionArea.points[0]=new Point(ab,ae);selectionArea.points[1]=new Point(ab,ae);selectionArea.points[2]=new Point(ab,ae);selectionArea.points[3]=new Point(ab,ae);aa=true;Log.info("onMouseMove() - STATE_GROUP_SELECTED + mousePressed + SHIFT => STATE_SELECTING_MULTIPLE")}}}}else{Log.debug("onMouseMove() - STATE_GROUP_SELECTED + mouse NOT pressed");if(HandleManager.handleGet(ab,ae)!=null){ak.style.cursor=HandleManager.handleGet(ab,ae).getCursor()}else{if(CONNECTOR_MANAGER.connectorGetByXY(ab,ae)!=-1){}else{if(STACK.figureIsOver(ab,ae)){ak.style.cursor="move"}else{ak.style.cursor="default"}}}}break;case STATE_CONNECTOR_PICK_FIRST:var T=CONNECTOR_MANAGER.connectionPointGetByXY(ab,ae,ConnectionPoint.TYPE_FIGURE);if(T!=-1){var S=CONNECTOR_MANAGER.connectionPointGetById(T);S.color=ConnectionPoint.OVER_COLOR;selectedConnectionPointId=T}else{if(selectedConnectionPointId!=-1){var af=CONNECTOR_MANAGER.connectionPointGetById(selectedConnectionPointId);af.color=ConnectionPoint.NORMAL_COLOR;selectedConnectionPointId=-1}}aa=true;break;case STATE_CONNECTOR_PICK_SECOND:connectorPickSecond(ab,ae,P);aa=true;break;case STATE_CONNECTOR_SELECTED:var ad=CONNECTOR_MANAGER.connectionPointGetAllByParent(selectedConnectorId);var ah=ad[0];var aj=ad[1];if(ah.point.near(ab,ae,3)||aj.point.near(ab,ae,3)){ak.style.cursor="move"}else{if(HandleManager.handleGet(ab,ae)!=null){ak.style.cursor=HandleManager.handleGet(ab,ae).getCursor()}else{ak.style.cursor="default"}}if(mousePressed==true&&lastMove!=null&&HandleManager.handleGetSelected()!=null){Log.info("onMouseMove() + STATE_CONNECTOR_SELECTED - trigger a handler action");var y=HandleManager.handleGetSelected();var an=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId).turningPoints;var i=[an.length];for(var ac=0;ac<an.length;ac++){i[ac]=an[ac].clone()}y.action(lastMove,ab,ae);an=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId).turningPoints;var Q=[an.length];for(var ac=0;ac<an.length;ac++){Q[ac]=an[ac].clone()}var x=false;for(var k=0;k<Q.length;k++){if(!Q[k].equals(i[k])){x=true}}aa=true}break;case STATE_CONNECTOR_MOVE_POINT:Log.info("Easy easy easy....it's fragile");if(mousePressed){connectorMovePoint(selectedConnectionPointId,ab,ae,P);aa=true}break}lastMove=[ab,ae];if(aa){draw()}return false}function onDblClick(s){var r=getCanvasXY(s);var p=r[0];var t=r[1];lastClick=[p,t];var v=null;var x=-1;var q=CONNECTOR_MANAGER.connectorGetByXY(p,t);var B=null;if(q!=-1){B=CONNECTOR_MANAGER.connectorGetById(q);v=B;x=0}else{q=CONNECTOR_MANAGER.connectorGetByTextXY(p,t);if(q!=-1){B=CONNECTOR_MANAGER.connectorGetById(q);v=B;x=0}else{var A=STACK.figureGetByXY(p,t);if(A!=-1){var u=STACK.figureGetById(A);var z=STACK.textGetByFigureXY(A,p,t);if(z!==-1){v=u;x=z}}else{var y=STACK.containerGetByXY(p,t);if(y!==-1){var C=STACK.containerGetById(y);var z=STACK.textGetByContainerXY(y,p,t);if(z!==-1){v=C;x=z}}}}}if(x!=-1){if(state==STATE_GROUP_SELECTED){var w=STACK.groupGetById(selectedGroupId);if(!w.permanent){STACK.groupDestroy(selectedGroupId)}selectedGroupId=-1}selectedFigureId=-1;selectedContainerId=-1;selectedConnectorId=-1;state=STATE_TEXT_EDITING;setUpTextEditorPopup(v,x);redraw=true}draw();return false}function connectorPickFirst(r,t,s){Log.group("connectorPickFirst");var w=CONNECTOR_MANAGER.connectorCreate(new Point(r,t),new Point(r+10,t+10),connectorType);selectedConnectorId=w;var z=CONNECTOR_MANAGER.connectorGetById(w);var u=CONNECTOR_MANAGER.connectionPointGetAllByParent(w);var A=STACK.figureGetByXY(r,t);var y=CONNECTOR_MANAGER.connectionPointGetByXY(r,t,ConnectionPoint.TYPE_FIGURE);if(y!=-1){var g=CONNECTOR_MANAGER.connectionPointGetById(y);u[0].point.x=g.point.x;u[0].point.y=g.point.y;z.turningPoints[0].x=g.point.x;z.turningPoints[0].y=g.point.y;var x=CONNECTOR_MANAGER.glueCreate(g.id,u[0].id,false);Log.info("First glue created : "+x)}else{if(A!==-1){var q=new Point(r,t);var p=CONNECTOR_MANAGER.getClosestPointsOfConnection(true,true,A,q,A,q);var v=p[0];u[0].point.x=u[1].point.x=v.x;u[0].point.y=u[1].point.y=v.y;z.turningPoints[0].x=z.turningPoints[1].x=v.x;z.turningPoints[0].y=z.turningPoints[1].y=v.y;var x=CONNECTOR_MANAGER.glueCreate(p[2],u[0].id,true);Log.info("First glue created : "+x)}}state=STATE_CONNECTOR_PICK_SECOND;Log.groupEnd()}function connectorPickSecond(H,I,x){Log.group("main: connectorPickSecond");var L=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId);var G=CONNECTOR_MANAGER.connectionPointGetAllByParent(L.id);var v=CONNECTOR_MANAGER.connectionPointGetByXY(H,I,ConnectionPoint.TYPE_FIGURE);var B=STACK.figureGetByXY(H,I);var w=L.turningPoints[0].clone();var E=CONNECTOR_MANAGER.glueGetBySecondConnectionPointId(G[0].id);var M=STACK.figureGetAsFirstFigureForConnector(L.id);if(M){Log.info(":) WE HAVE A START FIGURE id = "+M.id)}else{Log.info(":( WE DO NOT HAVE A START FIGURE")}var J=new Point(H,I);var A=null;if(v!=-1){var F=CONNECTOR_MANAGER.connectionPointGetById(v);Log.info("End Figure's ConnectionPoint present id = "+v);J=F.point.clone();A=STACK.figureGetById(F.parentId);Log.info(":) WE HAVE AN END FIGURE id = "+A.id)}else{if(B!=-1){Log.info("End Figure connected as automatic");J=new Point(H,I);A=STACK.figureGetById(B);Log.info(":) WE HAVE AN END FIGURE id = "+A.id)}else{Log.info(":( WE DO NOT HAVE AN END FIGURE ")}}var D=M?M.getBounds():null;var O=A?A.getBounds():null;var C=E.length>0&&E[0].automatic;var y=v!=-1?false:B!=-1;var K=CONNECTOR_MANAGER.getClosestPointsOfConnection(C,y,M?M.id:-1,w,A?A.id:-1,J);DIAGRAMO.debugSolutions=CONNECTOR_MANAGER.connector2Points(L.type,K[0],K[1],D,O);if(v!=-1||B!=-1){G[1].color=ConnectionPoint.OVER_COLOR}else{G[1].color=ConnectionPoint.NORMAL_COLOR}var N=CONNECTOR_MANAGER.connectionPointGetFirstForConnector(selectedConnectorId);var z=CONNECTOR_MANAGER.connectionPointGetSecondForConnector(selectedConnectorId);Log.info("connectorPickSecond() -> Solution: "+DIAGRAMO.debugSolutions[0][2]);L.turningPoints=Point.cloneArray(DIAGRAMO.debugSolutions[0][2]);N.point=L.turningPoints[0].clone();z.point=L.turningPoints[L.turningPoints.length-1].clone();L.updateMiddleText();currentCloud=[];CONNECTOR_MANAGER.glueRemoveAllBySecondId(z.id);if(v!=-1){CONNECTOR_MANAGER.glueCreate(v,CONNECTOR_MANAGER.connectionPointGetSecondForConnector(selectedConnectorId).id,false)}else{if(B!=-1){CONNECTOR_MANAGER.glueCreate(K[3],CONNECTOR_MANAGER.connectionPointGetSecondForConnector(selectedConnectorId).id,true)}else{v=CONNECTOR_MANAGER.connectionPointGetByXYRadius(H,I,FIGURE_CLOUD_DISTANCE,ConnectionPoint.TYPE_FIGURE,N);if(v!==-1){currentCloud=[v,z.id]}}}Log.groupEnd()}function connectorMovePoint(S,J,K,A){Log.group("main: connectorMovePoint");var O=CONNECTOR_MANAGER.connectorGetById(selectedConnectorId);var I=CONNECTOR_MANAGER.connectionPointGetAllByParent(O.id);var x=CONNECTOR_MANAGER.connectionPointGetByXY(J,K,ConnectionPoint.TYPE_FIGURE);var D=STACK.figureGetByXY(J,K);O.updateMiddleText();if(x!=-1||D!=-1){if(I[0].id==selectedConnectionPointId){I[0].color=ConnectionPoint.OVER_COLOR}else{I[1].color=ConnectionPoint.OVER_COLOR}}else{if(I[0].id==selectedConnectionPointId){I[0].color=ConnectionPoint.NORMAL_COLOR}else{I[1].color=ConnectionPoint.NORMAL_COLOR}}var z=O.turningPoints[0].clone();var P=null;var L=O.turningPoints[O.turningPoints.length-1].clone();var C=null;var G=CONNECTOR_MANAGER.glueGetBySecondConnectionPointId(I[0].id);var y=CONNECTOR_MANAGER.glueGetBySecondConnectionPointId(I[1].id);currentCloud=[];if(I[0].id==S){if(x!=-1){var H=CONNECTOR_MANAGER.connectionPointGetById(x);z=H.point.clone();P=STACK.figureGetById(H.parentId)}else{if(D!=-1){z=new Point(J,K);P=STACK.figureGetById(D)}else{z=new Point(J,K)}}C=STACK.figureGetAsSecondFigureForConnector(O.id);var F=P?P.getBounds():null;var R=C?C.getBounds():null;var B=y.length&&y[0].automatic;var E=x!=-1?false:D!=-1;var M=CONNECTOR_MANAGER.getClosestPointsOfConnection(E,B,P?P.id:-1,z,C?C.id:-1,L);DIAGRAMO.debugSolutions=CONNECTOR_MANAGER.connector2Points(O.type,M[0],M[1],F,R);var Q=CONNECTOR_MANAGER.connectionPointGetFirstForConnector(selectedConnectorId);var N=CONNECTOR_MANAGER.connectionPointGetSecondForConnector(selectedConnectorId);Log.info("connectorMovePoint() -> Solution: "+DIAGRAMO.debugSolutions[0][2]);O.turningPoints=Point.cloneArray(DIAGRAMO.debugSolutions[0][2]);Q.point=O.turningPoints[0].clone();N.point=O.turningPoints[O.turningPoints.length-1].clone();CONNECTOR_MANAGER.glueRemoveAllBySecondId(Q.id);if(x!=-1){CONNECTOR_MANAGER.glueCreate(x,Q.id,false)}else{if(D!=-1){CONNECTOR_MANAGER.glueCreate(M[2],Q.id,true)}else{x=CONNECTOR_MANAGER.connectionPointGetByXYRadius(J,K,FIGURE_CLOUD_DISTANCE,ConnectionPoint.TYPE_FIGURE,N);if(x!==-1){currentCloud=[x,Q.id]}}}}else{if(I[1].id==S){if(x!=-1){var H=CONNECTOR_MANAGER.connectionPointGetById(x);L=H.point.clone();C=STACK.figureGetById(H.parentId)}else{if(D!=-1){L=new Point(J,K);C=STACK.figureGetById(D)}else{L=new Point(J,K)}}P=STACK.figureGetAsFirstFigureForConnector(O.id);var F=P?P.getBounds():null;var R=C?C.getBounds():null;var E=G.length&&G[0].automatic;var B=x!=-1?false:D!=-1;var M=CONNECTOR_MANAGER.getClosestPointsOfConnection(E,B,P?P.id:-1,z,C?C.id:-1,L);DIAGRAMO.debugSolutions=CONNECTOR_MANAGER.connector2Points(O.type,M[0],M[1],F,R);var Q=CONNECTOR_MANAGER.connectionPointGetFirstForConnector(selectedConnectorId);var N=CONNECTOR_MANAGER.connectionPointGetSecondForConnector(selectedConnectorId);Log.info("connectorMovePoint() -> Solution: "+DIAGRAMO.debugSolutions[0][2]);O.turningPoints=Point.cloneArray(DIAGRAMO.debugSolutions[0][2]);Q.point=O.turningPoints[0].clone();N.point=O.turningPoints[O.turningPoints.length-1].clone();CONNECTOR_MANAGER.glueRemoveAllBySecondId(N.id);if(x!=-1){CONNECTOR_MANAGER.glueCreate(x,N.id,false)}else{if(D!=-1){CONNECTOR_MANAGER.glueCreate(M[3],N.id,true)}else{x=CONNECTOR_MANAGER.connectionPointGetByXYRadius(J,K,FIGURE_CLOUD_DISTANCE,ConnectionPoint.TYPE_FIGURE,Q);if(x!==-1){currentCloud=[x,N.id]}}}}else{throw"main:connectorMovePoint() - this should never happen"}}Log.groupEnd()}function generateMoveMatrix(D,w,x){if(typeof w==="undefined"){throw"Exception in generateMoveMatrix, x is undefined"}if(typeof x==="undefined"){throw"Exception in generateMoveMatrix,  is undefined"}Log.info("main.js --> generateMoveMatrix x:"+w+" y:"+x+" lastMove=["+lastMove+"]");var r=w-lastMove[0];var t=x-lastMove[1];var A=null;if(snapTo){A=[[1,0,0],[0,1,0],[0,0,1]];snapMonitor[0]+=r;snapMonitor[1]+=t;var q=GRIDWIDTH/2;if(r!=0){var v=(Math.floor((D.getBounds()[0]+snapMonitor[0])/q)+1)*q;var u=v-D.getBounds()[0];var B=(Math.floor((D.getBounds()[2]+snapMonitor[0])/q)+1)*q;var s=B-D.getBounds()[2];if(u<s){if(D.getBounds()[0]+snapMonitor[0]>=v-SNAP_DISTANCE){A[0][2]=u;snapMonitor[0]-=u}else{if(D.getBounds()[2]+snapMonitor[0]>=B-SNAP_DISTANCE){A[0][2]=s;snapMonitor[0]-=s}}}else{if(D.getBounds()[2]+snapMonitor[0]>=B-SNAP_DISTANCE){A[0][2]=s;snapMonitor[0]-=s}else{if(D.getBounds()[0]+snapMonitor[0]>=v-SNAP_DISTANCE){A[0][2]=u;snapMonitor[0]-=u}}}}if(t!=0){var z=(Math.floor((D.getBounds()[1]+snapMonitor[1])/q)+1)*q;var y=z-D.getBounds()[1];var E=(Math.floor((D.getBounds()[3]+snapMonitor[1])/q)+1)*q;var C=E-D.getBounds()[3];if(y<C){if(D.getBounds()[1]+snapMonitor[1]>=z-SNAP_DISTANCE){A[1][2]=y;snapMonitor[1]-=y}else{if(D.getBounds()[3]+snapMonitor[1]>=E-SNAP_DISTANCE){A[1][2]=C;snapMonitor[1]-=C}}}else{if(D.getBounds()[3]+snapMonitor[1]>=E-SNAP_DISTANCE){A[1][2]=C;snapMonitor[1]-=C}else{if(D.getBounds()[1]+snapMonitor[1]>=z-SNAP_DISTANCE){A[1][2]=y;snapMonitor[1]-=y}}}}}else{A=[[1,0,r],[0,1,t],[0,0,1]]}Log.groupEnd();return A}function getCanvasBounds(){var h=$("#a").offset().left;var e=h+$("#a").width();var i=$("#a").offset().top;var g=i+$("#a").height();return[h,i,e,g]}function getBodyXY(b){return[b.pageX,b.pageY]}function getCanvasXY(j){var h=null;var i=getCanvasBounds();Log.debug("Canvas bounds: ["+i+"]");var k=null;var g=null;if(j.touches){if(j.touches.length>0){k=j.touches[0].pageX;g=j.touches[0].pageY}}else{k=j.pageX;g=j.pageY;Log.debug("ev.pageX:"+j.pageX+" ev.pageY:"+j.pageY)}if(i[0]<=k&&k<=i[2]&&i[1]<=g&&g<=i[3]){h=[k-$("#a").offset().left,g-$("#a").offset().top]}return h}var backgroundImage=null;function addBackground(h){Log.info("addBackground: called");var i=h.getContext("2d");if(!backgroundImage){i.rect(0,0,h.width,h.height);i.fillStyle=canvasProps.getFillColor();i.fill();if(gridVisible){var k=Math.floor(h.width/GRIDWIDTH)+1;var j=Math.floor(h.height/GRIDWIDTH)+1;for(var l=0;l<j;l++){for(var m=0;m<k;m++){i.beginPath();i.strokeStyle="#C0C0C0";i.moveTo(m*GRIDWIDTH-2,l*GRIDWIDTH);i.lineTo(m*GRIDWIDTH+2,l*GRIDWIDTH);i.moveTo(m*GRIDWIDTH,l*GRIDWIDTH-2);i.lineTo(m*GRIDWIDTH,l*GRIDWIDTH+2);i.moveTo(m*GRIDWIDTH+GRIDWIDTH/2-1,l*GRIDWIDTH+GRIDWIDTH/2);i.lineTo(m*GRIDWIDTH+GRIDWIDTH/2+1,l*GRIDWIDTH+GRIDWIDTH/2);i.stroke()}}}backgroundImage=new Image();backgroundImage.src=h.toDataURL()}else{i.drawImage(backgroundImage,0,0)}}function reset(c){var d=c.getContext("2d");d.clearRect(0,0,c.width,c.height);d.fillStyle="#FFFFFF";d.fillRect(0,0,c.width,c.height)}function draw(){var b=getContext();reset(getCanvas());addBackground(getCanvas());STACK.paint(b);minimap.updateMinimap()}function renderedCanvas(){var d=getCanvas();var c=document.getElementById("tempCanvas");if(c===null){c=document.createElement("canvas");c.setAttribute("id","tempCanvas");c.style.display="none"}c.setAttribute("width",d.width);c.setAttribute("height",d.height);reset(c);addBackground(c);STACK.paint(c.getContext("2d"),true);return c.toDataURL()}function linkMap(){var i="";var h=true;for(f in STACK.figures){var g=STACK.figures[f];if(g.url!=""){var e=g.getBounds();if(h){h=false}else{i+="\n"}i+=e[0]+","+e[1]+","+e[2]+","+e[3]+","+g.url}}Log.info("editor.php->linkMap()->csv bounds: "+i);return i}function save(){Log.info("Save pressed");if(state==STATE_TEXT_EDITING){currentTextEditor.destroy();currentTextEditor=null;state=STATE_NONE}var k=null;try{k=renderedCanvas()}catch(m){if(m.name==="SecurityError"&&m.code===18){alert("A figure contains an image loaded from another host.                 \n\nHint:                 \nPlease make sure that the browser's URL (current location) is the same as the one saved in the DB.")}}if(k==null){Log.info("save(). Could not save. dataURL is null");alert("Could not save.             \n\nHint:             \nCanvas's toDataURL() did not functioned properly ");return}var i={c:canvasProps,s:STACK,m:CONNECTOR_MANAGER,p:CONTAINER_MANAGER,v:DIAGRAMO.fileVersion};var e=JSON.stringify(i);var l=toSVG();var j=linkMap();$.post("./common/controller.php",{action:"save",diagram:e,png:k,linkMap:j,svg:l,diagramId:currentDiagramId},function(a){if(a==="firstSave"){Log.info("firstSave!");window.location="./saveDiagram.php"}else{if(a==="saved"){alert("saved!")}else{alert("Unknown: "+a)}}})}function print_diagram(){var j="printFrame";var g=document.getElementById(j);if(g==null){g=document.createElement("IFRAME");g.id=j;document.body.appendChild(g)}var h=g.contentDocument;var i=h.getElementsByTagName("img");var k;if(i.length>0){k=i[0];k.setAttribute("src","data/diagrams/"+currentDiagramId+".png")}else{k=h.createElement("img");k.setAttribute("src","data/diagrams/"+currentDiagramId+".png");if(h.body!==null){h.body.appendChild(k)}else{h.src="javascript:'<body></body>'";h.write(k.outerHTML);h.close()}}g.setAttribute("width",canvasProps.getWidth());g.setAttribute("height",canvasProps.getHeight());g.contentWindow.print()}function exportCanvas(){var e='<svg width="300" height="200" xmlns="http://www.w3.org/2000/svg" version="1.1">            <rect x="0" y="0" height="200" width="300" style="stroke:#000000; fill: #FFFFFF"/>                    <path d="M100,100 C200,200 100,50 300,100" style="stroke:#FFAAFF;fill:none;stroke-width:3;"  />                    <rect x="50" y="50" height="50" width="50"                      style="stroke:#ff0000; fill: #ccccdf" />            </svg>';var d=getCanvas();var g='<svg width="'+d.width+'" height="'+d.height+'" xmlns="http://www.w3.org/2000/svg" version="1.1">';g+=STACK.toSVG();g+=CONNECTOR_MANAGER.toSVG();g+="</svg>";alert(g);$.post("../common/controller.php",{action:"saveSvg",svg:escape(g)},function(a){if(a=="svg_ok"){}else{if(a=="svg_failed"){Log.info("SVG was NOT save into session")}}});window.open("./svg.php","SVG","left=20,top=20,width=500,height=500,toolbar=1,resizable=0")}function load(diagramId){$.post("./common/controller.php",{action:"load",diagramId:diagramId},function(data){try{var obj=eval("("+data+")");if(!("v" in obj)||obj.v!=DIAGRAMO.fileVersion){Importer.importDiagram(obj)}STACK=Stack.load(obj.s);canvasProps=CanvasProps.load(obj.c);canvasProps.sync();setUpEditPanel(canvasProps);CONNECTOR_MANAGER=ConnectorManager.load(obj.m);CONTAINER_MANAGER=ContainerFigureManager.load(obj.p);draw()}catch(error){alert("main.js:load() Exception: "+error)}})}function loadTempDiagram(tempDiagramName){$.post("./common/controller.php",{action:"loadTemp",tempName:tempDiagramName},function(data){try{var obj=eval("("+data+")");if(!("v" in obj)||obj.v!=DIAGRAMO.fileVersion){Importer.importDiagram(obj)}STACK=Stack.load(obj.s);canvasProps=CanvasProps.load(obj.c);canvasProps.sync();setUpEditPanel(canvasProps);CONNECTOR_MANAGER=ConnectorManager.load(obj.m);CONTAINER_MANAGER=ContainerFigureManager.load(obj.p);draw()}catch(error){alert("main.js:load() Exception: "+error)}})}function saveAs(){var k=renderedCanvas();var h={c:canvasProps,s:STACK,m:CONNECTOR_MANAGER,p:CONTAINER_MANAGER,v:DIAGRAMO.fileVersion};var i=JSON.stringify(h);var g=toSVG();var j=linkMap();$.post("./common/controller.php",{action:"saveAs",diagram:i,png:k,linkMap:j,svg:g},function(a){if(a=="noaccount"){Log.info("You must have an account to use that feature")}else{if(a=="step1Ok"){Log.info("Save as...");window.location="./saveDiagram.php"}}})}function addListeners(){var b=getCanvas();document.addEventListener("keypress",onKeyPress,false);document.addEventListener("keydown",onKeyDown,false);document.addEventListener("keyup",onKeyUp,false);document.addEventListener("selectstart",stopselection,false);b.addEventListener("mousemove",onMouseMove,false);b.addEventListener("mousedown",onMouseDown,false);b.addEventListener("mouseup",onMouseUp,false);b.addEventListener("dblclick",onDblClick,false);if(false){ontouchstart="touchStart(event);";ontouchmove="touchMove(event);";ontouchend="touchEnd(event);";ontouchcancel="touchCancel(event);"}}var minimap;$(document).mouseup(function(){minimap.selected=false});window.onresize=function(){minimap.initMinimap()};var currentDiagramId=null;function init(d){var c=getCanvas();minimap=new Minimap(c,document.getElementById("minimap"),115);minimap.updateMinimap();if(canvasProps==null){canvasProps=new CanvasProps(CanvasProps.DEFAULT_WIDTH,CanvasProps.DEFAULT_HEIGHT,CanvasProps.DEFAULT_FILL_COLOR)}canvasProps.setWidth(canvasProps.getWidth());canvasProps.setHeight(canvasProps.getHeight());if(isBrowserReady()==0){modal()}setUpEditPanel(canvasProps);if(isNumeric(d)){currentDiagramId=d;load(d)}else{if(d.substring&&d.substring(0,3)==="tmp"){loadTempDiagram(d)}}addListeners();window.addEventListener("mousedown",documentOnMouseDown,false);window.addEventListener("mousemove",documentOnMouseMove,false);window.addEventListener("mouseup",documentOnMouseUp,false)}var redraw=false;function action(J){redraw=false;switch(J){case"undo":Log.info("main.js->action()->Undo. Nr of actions in the STACK: "+History.COMMANDS.length);History.undo();redraw=true;break;case"group":if(selectedGroupId!=-1){var S=STACK.groupGetById(selectedGroupId);if(!S.permanent){var W=new GroupCreateCommand(selectedGroupId);W.execute();History.addUndo(W);Log.info("main.js->action()->Group. New group made permanent. Group id = "+selectedGroupId)}else{Log.info("main.js->action()->Group. Group ALREADY permanent.  Group id = "+selectedGroupId)}}redraw=true;break;case"container":Log.info("main.js->action()->container. Nr of actions in the STACK: "+History.COMMANDS.length);if(state==STATE_TEXT_EDITING){currentTextEditor.destroy();currentTextEditor=null}var X=new ContainerCreateCommand(300,300);X.execute();History.addUndo(X);redraw=true;break;case"insertImage":Log.info("main.js->action()->insertImage. Nr of actions in the STACK: "+History.COMMANDS.length);if(state==STATE_TEXT_EDITING){currentTextEditor.destroy();currentTextEditor=null}var E=new InsertedImageFigureCreateCommand(insertedImageFileName,100,100);E.execute();History.addUndo(E);redraw=true;break;case"ungroup":if(selectedGroupId!=-1){var S=STACK.groupGetById(selectedGroupId);if(S.permanent){var V=new GroupDestroyCommand(selectedGroupId);V.execute();History.addUndo(V);Log.info("main.js->action()->Ungroup. New group made permanent. Group id = "+selectedGroupId)}else{Log.info("main.js->action()->Ungroup. Ignore. Group is not permanent.  Group id = "+selectedGroupId)}redraw=true}break;case"connector-jagged":if(state==STATE_TEXT_EDITING){currentTextEditor.destroy();currentTextEditor=null}selectedFigureId=-1;state=STATE_CONNECTOR_PICK_FIRST;connectorType=Connector.TYPE_JAGGED;redraw=true;break;case"connector-straight":if(state==STATE_TEXT_EDITING){currentTextEditor.destroy();currentTextEditor=null}selectedFigureId=-1;state=STATE_CONNECTOR_PICK_FIRST;connectorType=Connector.TYPE_STRAIGHT;redraw=true;break;case"connector-organic":if(state==STATE_TEXT_EDITING){currentTextEditor.destroy();currentTextEditor=null}selectedFigureId=-1;state=STATE_CONNECTOR_PICK_FIRST;connectorType=Connector.TYPE_ORGANIC;redraw=true;break;case"rotate90":case"rotate90A":if(selectedFigureId){var N=STACK.figureGetById(selectedFigureId);var T=N.getBounds();var O=T[0]+(T[2]-T[0])/2;var Q=T[1]+(T[3]-T[1])/2;var Y=[[1,0,O*-1],[0,1,Q*-1],[0,0,1]];var F=[[1,0,O],[0,1,Q],[0,0,1]];N.transform(Y);if(J=="rotate90"){N.transform(R90)}else{N.transform(R90A)}N.transform(F);redraw=true}break;case"up":switch(state){case STATE_FIGURE_SELECTED:var L=new FigureTranslateCommand(selectedFigureId,Matrix.UP);History.addUndo(L);L.execute();redraw=true;break;case STATE_GROUP_SELECTED:var D=new GroupTranslateCommand(selectedGroupId,Matrix.UP);History.addUndo(D);D.execute();redraw=true;break}break;case"down":switch(state){case STATE_FIGURE_SELECTED:var P=new FigureTranslateCommand(selectedFigureId,Matrix.DOWN);History.addUndo(P);P.execute();redraw=true;break;case STATE_GROUP_SELECTED:var M=new GroupTranslateCommand(selectedGroupId,Matrix.DOWN);History.addUndo(M);M.execute();redraw=true;break}break;case"right":switch(state){case STATE_FIGURE_SELECTED:var K=new FigureTranslateCommand(selectedFigureId,Matrix.RIGHT);History.addUndo(K);K.execute();redraw=true;break;case STATE_GROUP_SELECTED:var I=new GroupTranslateCommand(selectedGroupId,Matrix.RIGHT);History.addUndo(I);I.execute();redraw=true;break}break;case"left":switch(state){case STATE_FIGURE_SELECTED:var Z=new FigureTranslateCommand(selectedFigureId,Matrix.LEFT);History.addUndo(Z);Z.execute();redraw=true;break;case STATE_GROUP_SELECTED:var U=new GroupTranslateCommand(selectedGroupId,Matrix.LEFT);History.addUndo(U);U.execute();redraw=true;break}break;case"grow":if(selectedFigureId!=-1){var N=STACK.figureGetById(selectedFigureId);var T=N.getBounds();var O=T[0]+(T[2]-T[0])/2;var Q=T[1]+(T[3]-T[1])/2;var Y=[[1,0,O*-1],[0,1,Q*-1],[0,0,1]];var F=[[1,0,O],[0,1,Q],[0,0,1]];var C=[[1+0.2,0,0],[0,1+0.2,0],[0,0,1]];N.transform(Y);N.transform(C);N.transform(F);redraw=true}break;case"shrink":if(selectedFigureId!=-1){var N=STACK.figureGetById(selectedFigureId);var T=N.getBounds();var O=T[0]+(T[2]-T[0])/2;var Q=T[1]+(T[3]-T[1])/2;var Y=[[1,0,O*-1],[0,1,Q*-1],[0,0,1]];var F=[[1,0,O],[0,1,Q],[0,0,1]];var ac=[[1-0.2,0,0],[0,1-0.2,0],[0,0,1]];N.transform(Y);N.transform(ac);N.transform(F);redraw=true}break;case"duplicate":if(selectedFigureId!=-1){var G=new FigureCloneCommand(selectedFigureId);G.execute();History.addUndo(G)}if(selectedGroupId!=-1){var G=new GroupCloneCommand(selectedGroupId);G.execute();History.addUndo(G)}getCanvas().style.cursor="default";redraw=true;break;case"back":if(selectedFigureId!=-1){var ab=new FigureZOrderCommand(selectedFigureId,0);ab.execute();History.addUndo(ab);redraw=true}break;case"front":if(selectedFigureId!=-1){var aa=new FigureZOrderCommand(selectedFigureId,STACK.figures.length-1);aa.execute();History.addUndo(aa);redraw=true}break;case"moveback":if(selectedFigureId!=-1){var H=new FigureZOrderCommand(selectedFigureId,STACK.idToIndex[selectedFigureId]-1);H.execute();History.addUndo(H);redraw=true}break;case"moveforward":if(selectedFigureId!=-1){var R=new FigureZOrderCommand(selectedFigureId,STACK.idToIndex[selectedFigureId]+1);R.execute();History.addUndo(R);redraw=true}break}if(redraw){draw()}}var lastMousePosition=null;function documentOnMouseDown(b){}var draggingFigure=null;function documentOnMouseMove(b){switch(state){case STATE_FIGURE_CREATE:if(!draggingFigure){draggingFigure=document.createElement("img");draggingFigure.setAttribute("id","draggingThumb");draggingFigure.style.position="absolute";draggingFigure.style.zIndex=3;body.appendChild(draggingFigure)}draggingFigure.setAttribute("src",selectedFigureThumb);draggingFigure.style.width="100px";draggingFigure.style.height="100px";draggingFigure.style.left=(b.pageX-50)+"px";draggingFigure.style.top=(b.pageY-50)+"px";draggingFigure.style.display="block";draggingFigure.addEventListener("mousedown",function(a){},false);draggingFigure.addEventListener("mouseup",function(j){var i=getCanvasXY(j);if(i==null){return}var a=i[0];var h=i[1];switch(state){case STATE_FIGURE_CREATE:Log.info("draggingFigure>onMouseUp() + STATE_FIGURE_CREATE");snapMonitor=[0,0];if(window.createFigureFunction){var k=new FigureCreateCommand(window.createFigureFunction,a,h);k.execute();History.addUndo(k);selectedConnectorId=-1;createFigureFunction=null;mousePressed=false;redraw=true;draw();document.getElementById("draggingThumb").style.display="none"}else{Log.info("draggingFigure>onMouseUp() + STATE_FIGURE_CREATE--> but no 'createFigureFunction'")}break}b.stopPropagation()},false);break;case STATE_NONE:break}}function documentOnMouseUp(d){Log.info("documentOnMouseUp");switch(state){case STATE_FIGURE_CREATE:var c=document.elementFromPoint(d.clientX,d.clientY);if(c.id!="a"){if(draggingFigure){draggingFigure.parentNode.removeChild(draggingFigure);state=STATE_NONE;draggingFigure=null}}break}}function linkMap(){var k="";var i=true;for(var j in STACK.figures){var h=STACK.figures[j];if(h.url!=""){var g=h.getBounds();if(i){i=false}else{k+="\n"}k+=g[0]+","+g[1]+","+g[2]+","+g[3]+","+h.url}}Log.info("editor.php->linkMap()->csv bounds: "+k);return k}function touchStart(b){b.preventDefault();onMouseDown(b)}function touchMove(b){b.preventDefault();onMouseMove(b)}function touchEnd(b){onMouseUp(b)}function touchCancel(b){};